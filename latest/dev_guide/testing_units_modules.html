<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unit Testing Ansible Modules &mdash; Ansible Documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="_static/images/Ansible-Mark-RGB_Black.svg"/>
    <link rel="canonical" href="https://docs.ansible.com/ansible/latest/dev_guide/testing_units_modules.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->
<script src="https://www.redhat.com/dtm.js"></script>


<!-- <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> -->
<meta class="swiftype" name="version" data-type="string" content="6">

<!-- Google Tag Manager Data Layer -->
<script>
 dataLayer = [];
</script>
<!-- End Google Tag Manager Data Layer -->



<script>
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','https://s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->
<!-- Google Tag Manager -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
<!-- End Google Tag Manager -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/Ansible-Mark-RGB_White.svg"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Ansible
          </a>
              <div class="version">
                6
              </div><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    <div class="version-dropdown">
      <script>
        function switchVersionTo(slug) {
          var current_url_path = window.location.pathname;
          var url_version = current_url_path.search("/6/") > -1
            ? "/6/"
            : "/latest/";
          var new_version_url = current_url_path.replace(url_version, "/" + slug + "/");
          window.location.replace(new_version_url);
        }
      </script>
      <select
          class="version-list"
          id="version-list"
          onchange="switchVersionTo(this.value);"
      >
        
        <option
            value="latest"
            
        >
            latest
        </option>
        
        <option
            value="2.9"
            
        >
            2.9
        </option>
        
        <option
            value="devel"
            
        >
            devel
        </option>
        
      </select>
    </div>
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" method="get">
    <input type="text" class="st-default-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Ansible getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started with Ansible</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation, Upgrade &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_guide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting_guides/porting_guides.html">Ansible Porting Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Ansible Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions_collections.html">Ansible Collections Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions.html">ansible-core Contributors Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/advanced_index.html">Advanced Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="style_guide/index.html">Ansible documentation style guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Ansible Scenarios</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/cloud_guides.html">Legacy Public Cloud Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/network_guides.html">Network Technology Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/virt_guides.html">Virtualization and Containerization Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Automation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/getting_started/index.html">Network Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/user_guide/index.html">Network Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dev_guide/index.html">Network Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ansible Galaxy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/user_guide.html">Galaxy User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/dev_guide.html">Galaxy Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference &amp; Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collections/index.html">Collection Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collections/all_plugins.html">Indexes of all modules and plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/playbooks_keywords.html">Playbook Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/common_return_values.html">Return Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/config.html">Ansible Configuration Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/general_precedence.html">Controlling how Ansible behaves: precedence rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/YAMLSyntax.html">YAML Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/python_3_support.html">Python 3 Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/interpreter_discovery.html">Interpreter Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/release_and_maintenance.html">Releases and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/test_strategies.html">Testing Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing/sanity/index.html">Sanity Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/module_utils.html">Ansible Reference: Module Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/special_variables.html">Special Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/tower.html">Red Hat Ansible Automation Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/automationhub.html">Ansible Automation Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/logging.html">Logging Ansible output</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Roadmaps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_roadmap_index.html">Ansible Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_core_roadmap_index.html">ansible-core Roadmaps</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->
<!-- changeable widget links to tower - do not change as image controlled by Ansible-->
<div id="sideBanner">
  <br/>
  <a href="https://www.ansible.com/docs-left?utm_source=docs">
    <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
  </a>
  <br/><br/><br/>
</div>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Unit Testing Ansible Modules</li>
  <li class="wy-breadcrumbs-aside">
          <!-- Ansible-specific additions for modules etc -->
            
              <a href="https://github.com/ansible/ansible/edit/devel/docs/docsite/rst/dev_guide/testing_units_modules.rst?description=%23%23%23%23%23%20SUMMARY%0A%3C!---%20Your%20description%20here%20--%3E%0A%0A%0A%23%23%23%23%23%20ISSUE%20TYPE%0A-%20Docs%20Pull%20Request%0A%0A%2Blabel:%20docsite_pr" class="fa fa-github"> Edit on GitHub</a>
            
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  <script>
    function startsWith(str, needle) {
      return str.slice(0, needle.length) == needle
    }
    function startsWithOneOf(str, needles) {
      return needles.some(function (needle) {
        return startsWith(str, needle);
      });
    }
    var banner = '';
      var extra_banner = '';
    /*use extra_banner for when marketing wants something extra, like a survey or AnsibleFest notice
    var extra_banner =
      '<div id="latest_extra_banner_id" class="admonition important">' +
      '<br>' +
      '<p>' +
        'You\'re invited to AnsibleFest 2021! ' +
      '<p>' +
        'Explore ways to automate, innovate, and accelerate with our free virtual event September 29-30. ' +
      '<pr>' +
        '<a href="https://reg.ansiblefest.redhat.com/flow/redhat/ansible21/regGenAttendee/login?sc_cid=7013a000002pemAAAQ">Register now!</a> ' +
      '</p>' +
      '<br>' +
      '</div>'; */
    // Create a banner if we're not on the official docs site
    if (location.host == "docs.testing.ansible.com") {
      document.write('<div id="testing_banner_id" class="admonition important">' +
                     '<p>This is the testing site for Ansible Documentation. Unless you are reviewing pre-production changes, please visit the <a href="https://docs.ansible.com/ansible/latest/">official documentation website</a>.</p> <p></p>' +
                     '</div>');
    }
    
      // Create a banner
      current_url_path = window.location.pathname;

      var important = false;
      var msg = '<p>';
      if (startsWith(current_url_path, "/ansible-core/")) {
        msg += 'You are reading documentation for Ansible Core, which contains no plugins except for those in ansible.builtin. For documentation of the Ansible package, go to <a href="/ansible/latest">the latest documentation</a>.';
      } else if (startsWithOneOf(current_url_path, ["/ansible/latest/", "/ansible/6/"])) {
        /* temp extra banner to advertise AnsibeFest2021 */
        banner += extra_banner;

        msg += 'You are reading the <b>latest</b> (stable) community version of the Ansible documentation. Red Hat subscribers, select <b>2.9</b> in the version selection to the left for the most recent Red Hat release.';
      } else if (startsWith(current_url_path, "/ansible/2.9/")) {
        msg += 'You are reading the latest Red Hat released version of the Ansible documentation. Community users can use this version, or select <b>latest</b> from the version selector to the left for the most recent community version.';
      } else if (startsWith(current_url_path, "/ansible/devel/")) {
        /* temp extra banner to advertise AnsibleFest2021 */
        banner += extra_banner;

        /* temp banner to advertise survey
        important = true;
        msg += 'Please take our <a href="https://www.surveymonkey.co.uk/r/B9V3CDY">Docs survey</a> before December 31 to help us improve Ansible documentation.';
        */

        msg += 'You are reading the <b>devel</b> version of the Ansible documentation - this version is not guaranteed stable. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
      } else {
        msg += 'You are reading an older version of the Ansible documentation. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
      }
      msg += '</p>';

      banner += '<div id="banner_id" class="admonition ';
      banner += important ? 'important' : 'caution';
      banner += '">';
      banner += important ? '<br>' : '';
      banner += msg;
      banner += important ? '<br>' : '';
      banner += '</div>';
      document.write(banner);
    
  </script>


  
           <div itemprop="articleBody">
             
  <section id="unit-testing-ansible-modules">
<span id="testing-units-modules"></span><h1><a class="toc-backref" href="#id1">Unit Testing Ansible Modules</a><a class="headerlink" href="#unit-testing-ansible-modules" title="Permalink to this headline"></a></h1>
<div class="contents topic" id="topics">
<p class="topic-title">Topics</p>
<ul class="simple">
<li><p><a class="reference internal" href="#unit-testing-ansible-modules" id="id1">Unit Testing Ansible Modules</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p></li>
<li><p><a class="reference internal" href="#what-are-unit-tests" id="id3">What Are Unit Tests?</a></p></li>
<li><p><a class="reference internal" href="#why-use-unit-tests" id="id4">Why Use Unit Tests?</a></p></li>
<li><p><a class="reference internal" href="#when-to-use-unit-tests" id="id5">When To Use Unit Tests</a></p>
<ul>
<li><p><a class="reference internal" href="#providing-quick-feedback" id="id6">Providing quick feedback</a></p></li>
<li><p><a class="reference internal" href="#ensuring-correct-use-of-external-interfaces" id="id7">Ensuring correct use of external interfaces</a></p></li>
<li><p><a class="reference internal" href="#providing-specific-design-tests" id="id8">Providing specific design tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-unit-test-ansible-modules" id="id9">How to unit test Ansible modules</a></p>
<ul>
<li><p><a class="reference internal" href="#naming-unit-tests" id="id10">Naming unit tests</a></p></li>
<li><p><a class="reference internal" href="#use-of-mocks" id="id11">Use of Mocks</a></p></li>
<li><p><a class="reference internal" href="#ensuring-failure-cases-are-visible-with-mock-objects" id="id12">Ensuring failure cases are visible with mock objects</a></p></li>
<li><p><a class="reference internal" href="#mocking-of-the-actual-module" id="id13">Mocking of the actual module</a></p></li>
<li><p><a class="reference internal" href="#api-definition-with-unit-test-cases" id="id14">API definition with unit test cases</a></p>
<ul>
<li><p><a class="reference internal" href="#defining-a-module-against-an-api-specification" id="id15">Defining a module against an API specification</a></p></li>
<li><p><a class="reference internal" href="#defining-a-module-to-work-against-multiple-api-versions" id="id16">Defining a module to work against multiple API versions</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#ansible-special-cases-for-unit-testing" id="id17">Ansible special cases for unit testing</a></p>
<ul>
<li><p><a class="reference internal" href="#module-argument-processing" id="id18">Module argument processing</a></p></li>
<li><p><a class="reference internal" href="#passing-arguments" id="id19">Passing Arguments</a></p></li>
<li><p><a class="reference internal" href="#handling-exit-correctly" id="id20">Handling exit correctly</a></p></li>
<li><p><a class="reference internal" href="#running-the-main-function" id="id21">Running the main function</a></p></li>
<li><p><a class="reference internal" href="#handling-calls-to-external-executables" id="id22">Handling calls to external executables</a></p></li>
<li><p><a class="reference internal" href="#a-complete-example" id="id23">A Complete Example</a></p></li>
<li><p><a class="reference internal" href="#restructuring-modules-to-enable-testing-module-set-up-and-other-processes" id="id24">Restructuring modules to enable testing module set up and other processes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#traps-for-maintaining-python-2-compatibility" id="id25">Traps for maintaining Python 2 compatibility</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>This document explains why, how and when you should use unit tests for Ansible modules.
The document doesn’t apply to other parts of Ansible for which the recommendations are
normally closer to the Python standard. There is basic documentation for Ansible unit
tests in the developer guide <a class="reference internal" href="testing_units.html#testing-units"><span class="std std-ref">Unit Tests</span></a>. This document should
be readable for a new Ansible module author. If you find it incomplete or confusing,
please open a bug or ask for help on the #ansible-devel chat channel (using Matrix at ansible.im or using IRC at <a class="reference external" href="https://libera.chat/">irc.libera.chat</a>).</p>
</section>
<section id="what-are-unit-tests">
<h2><a class="toc-backref" href="#id3">What Are Unit Tests?</a><a class="headerlink" href="#what-are-unit-tests" title="Permalink to this headline"></a></h2>
<p>Ansible includes a set of unit tests in the <code class="file docutils literal notranslate"><span class="pre">test/units</span></code> directory. These tests primarily cover the
internals but can also cover Ansible modules. The structure of the unit tests matches
the structure of the code base, so the tests that reside in the <code class="file docutils literal notranslate"><span class="pre">test/units/modules/</span></code> directory
are organized by module groups.</p>
<p>Integration tests can be used for most modules, but there are situations where
cases cannot be verified using integration tests. This means that Ansible unit test cases
may extend beyond testing only minimal units and in some cases will include some
level of functional testing.</p>
</section>
<section id="why-use-unit-tests">
<h2><a class="toc-backref" href="#id4">Why Use Unit Tests?</a><a class="headerlink" href="#why-use-unit-tests" title="Permalink to this headline"></a></h2>
<p>Ansible unit tests have advantages and disadvantages. It is important to understand these.
Advantages include:</p>
<ul class="simple">
<li><p>Most unit tests are much faster than most Ansible integration tests. The complete suite
of unit tests can be run regularly by a developer on their local system.</p></li>
<li><p>Unit tests can be run by developers who don’t have access to the system which the module is
designed to work on, allowing a level of verification that changes to core functions
haven’t broken module expectations.</p></li>
<li><p>Unit tests can easily substitute system functions allowing testing of software that
would be impractical. For example, the <code class="docutils literal notranslate"><span class="pre">sleep()</span></code> function can be replaced and we check
that a ten minute sleep was called without actually waiting ten minutes.</p></li>
<li><p>Unit tests are run on different Python versions. This allows us to
ensure that the code behaves in the same way on different Python versions.</p></li>
</ul>
<p>There are also some potential disadvantages of unit tests. Unit tests don’t normally
directly test actual useful valuable features of software, instead just internal
implementation</p>
<ul class="simple">
<li><p>Unit tests that test the internal, non-visible features of software may make
refactoring difficult if those internal features have to change (see also naming in How
below)</p></li>
<li><p>Even if the internal feature is working correctly it is possible that there will be a
problem between the internal code tested and the actual result delivered to the user</p></li>
</ul>
<p>Normally the Ansible integration tests (which are written in Ansible YAML) provide better
testing for most module functionality. If those tests already test a feature and perform
well there may be little point in providing a unit test covering the same area as well.</p>
</section>
<section id="when-to-use-unit-tests">
<h2><a class="toc-backref" href="#id5">When To Use Unit Tests</a><a class="headerlink" href="#when-to-use-unit-tests" title="Permalink to this headline"></a></h2>
<p>There are a number of situations where unit tests are a better choice than integration
tests. For example, testing things which are impossible, slow or very difficult to test
with integration tests, such as:</p>
<ul class="simple">
<li><p>Forcing rare / strange / random situations that can’t be forced, such as specific network
failures and exceptions</p></li>
<li><p>Extensive testing of slow configuration APIs</p></li>
<li><p>Situations where the integration tests cannot be run as part of the main Ansible
continuous integration running in Azure Pipelines.</p></li>
</ul>
<section id="providing-quick-feedback">
<h3><a class="toc-backref" href="#id6">Providing quick feedback</a><a class="headerlink" href="#providing-quick-feedback" title="Permalink to this headline"></a></h3>
<dl class="simple">
<dt>Example:</dt><dd><p>A single step of the rds_instance test cases can take up to 20
minutes (the time to create an RDS instance in Amazon). The entire
test run can last for well over an hour. All 16 of the unit tests
complete execution in less than 2 seconds.</p>
</dd>
</dl>
<p>The time saving provided by being able to run the code in a unit test makes it worth
creating a unit test when bug fixing a module, even if those tests do not often identify
problems later. As a basic goal, every module should have at least one unit test which
will give quick feedback in easy cases without having to wait for the integration tests to
complete.</p>
</section>
<section id="ensuring-correct-use-of-external-interfaces">
<h3><a class="toc-backref" href="#id7">Ensuring correct use of external interfaces</a><a class="headerlink" href="#ensuring-correct-use-of-external-interfaces" title="Permalink to this headline"></a></h3>
<p>Unit tests can check the way in which external services are run to ensure that they match
specifications or are as efficient as possible <em>even when the final output will not be changed</em>.</p>
<dl class="simple">
<dt>Example:</dt><dd><p>Package managers are often far more efficient when installing multiple packages at once
rather than each package separately. The final result is the
same: the packages are all installed, so the efficiency is difficult to verify through
integration tests. By providing a mock package manager and verifying that it is called
once, we can build a valuable test for module efficiency.</p>
</dd>
</dl>
<p>Another related use is in the situation where an API has versions which behave
differently. A programmer working on a new version may change the module to work with the
new API version and unintentionally break the old version. A test case
which checks that the call happens properly for the old version can help avoid the
problem. In this situation it is very important to include version numbering in the test case
name (see <a class="reference internal" href="#naming-unit-tests">Naming unit tests</a> below).</p>
</section>
<section id="providing-specific-design-tests">
<h3><a class="toc-backref" href="#id8">Providing specific design tests</a><a class="headerlink" href="#providing-specific-design-tests" title="Permalink to this headline"></a></h3>
<p>By building a requirement for a particular part of the
code and then coding to that requirement, unit tests _can_ sometimes improve the code and
help future developers understand that code.</p>
<p>Unit tests that test internal implementation details of code, on the other hand, almost
always do more harm than good.  Testing that your packages to install are stored in a list
would slow down and confuse a future developer who might need to change that list into a
dictionary for efficiency. This problem can be reduced somewhat with clear test naming so
that the future developer immediately knows to delete the test case, but it is often
better to simply leave out the test case altogether and test for a real valuable feature
of the code, such as installing all of the packages supplied as arguments to the module.</p>
</section>
</section>
<section id="how-to-unit-test-ansible-modules">
<h2><a class="toc-backref" href="#id9">How to unit test Ansible modules</a><a class="headerlink" href="#how-to-unit-test-ansible-modules" title="Permalink to this headline"></a></h2>
<p>There are a number of techniques for unit testing modules. Beware that most
modules without unit tests are structured in a way that makes testing quite difficult and
can lead to very complicated tests which need more work than the code. Effectively using unit
tests may lead you to restructure your code. This is often a good thing and leads
to better code overall. Good restructuring can make your code clearer and easier to understand.</p>
<section id="naming-unit-tests">
<h3><a class="toc-backref" href="#id10">Naming unit tests</a><a class="headerlink" href="#naming-unit-tests" title="Permalink to this headline"></a></h3>
<p>Unit tests should have logical names. If a developer working on the module being tested
breaks the test case, it should be easy to figure what the unit test covers from the name.
If a unit test is designed to verify compatibility with a specific software or API version
then include the version in the name of the unit test.</p>
<p>As an example, <code class="docutils literal notranslate"><span class="pre">test_v2_state_present_should_call_create_server_with_name()</span></code> would be a
good name, <code class="docutils literal notranslate"><span class="pre">test_create_server()</span></code> would not be.</p>
</section>
<section id="use-of-mocks">
<h3><a class="toc-backref" href="#id11">Use of Mocks</a><a class="headerlink" href="#use-of-mocks" title="Permalink to this headline"></a></h3>
<p>Mock objects (from <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">https://docs.python.org/3/library/unittest.mock.html</a>) can be very
useful in building unit tests for special / difficult cases, but they can also
lead to complex and confusing coding situations. One good use for mocks would be in
simulating an API. As for ‘six’, the ‘mock’ python package is bundled with Ansible (use
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">units.compat.mock</span></code>).</p>
</section>
<section id="ensuring-failure-cases-are-visible-with-mock-objects">
<h3><a class="toc-backref" href="#id12">Ensuring failure cases are visible with mock objects</a><a class="headerlink" href="#ensuring-failure-cases-are-visible-with-mock-objects" title="Permalink to this headline"></a></h3>
<p>Functions like <a class="reference internal" href="../api/index.html#module.fail_json" title="module.fail_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.fail_json()</span></code></a> are normally expected to terminate execution. When you
run with a mock module object this doesn’t happen since the mock always returns another mock
from a function call. You can set up the mock to raise an exception as shown above, or you can
assert that these functions have not been called in each test. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">function_to_test</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
<span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</pre></div>
</div>
<p>This applies not only to calling the main module but almost any other
function in a module which gets the module object.</p>
</section>
<section id="mocking-of-the-actual-module">
<h3><a class="toc-backref" href="#id13">Mocking of the actual module</a><a class="headerlink" href="#mocking-of-the-actual-module" title="Permalink to this headline"></a></h3>
<p>The setup of an actual module is quite complex (see <a class="reference internal" href="#passing-arguments">Passing Arguments</a> below) and often
isn’t needed for most functions which use a module. Instead you can use a mock object as
the module and create any module attributes needed by the function you are testing. If
you do this, beware that the module exit functions need special handling as mentioned
above, either by throwing an exception or ensuring that they haven’t been called. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AnsibleExitJson</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception class to be raised by module.exit_json and caught by the test case&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="c1"># you may also do the same to fail json</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">AnsibleExitJson</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleExitJson</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">my_module</span><span class="o">.</span><span class="n">test_this_function</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
<span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;changed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
<section id="api-definition-with-unit-test-cases">
<h3><a class="toc-backref" href="#id14">API definition with unit test cases</a><a class="headerlink" href="#api-definition-with-unit-test-cases" title="Permalink to this headline"></a></h3>
<p>API interaction is usually best tested with the function tests defined in Ansible’s
integration testing section, which run against the actual API. There are several cases
where the unit tests are likely to work better.</p>
<section id="defining-a-module-against-an-api-specification">
<h4><a class="toc-backref" href="#id15">Defining a module against an API specification</a><a class="headerlink" href="#defining-a-module-against-an-api-specification" title="Permalink to this headline"></a></h4>
<p>This case is especially important for modules interacting with web services, which provide
an API that Ansible uses but which are beyond the control of the user.</p>
<p>By writing a custom emulation of the calls that return data from the API, we can ensure
that only the features which are clearly defined in the specification of the API are
present in the message. This means that we can check that we use the correct
parameters and nothing else.</p>
<p><em>Example:  in rds_instance unit tests a simple instance state is defined</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_instance_list</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">pending</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;DBInstances&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="sa">u</span><span class="s1">&#39;DBInstanceArn&#39;</span><span class="p">:</span> <span class="s1">&#39;arn:aws:rds:us-east-1:1234567890:db:fakedb&#39;</span><span class="p">,</span>
                              <span class="sa">u</span><span class="s1">&#39;DBInstanceStatus&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                              <span class="sa">u</span><span class="s1">&#39;PendingModifiedValues&#39;</span><span class="p">:</span> <span class="n">pending</span><span class="p">,</span>
                              <span class="sa">u</span><span class="s1">&#39;DBInstanceIdentifier&#39;</span><span class="p">:</span> <span class="s1">&#39;fakedb&#39;</span><span class="p">}]}</span>
</pre></div>
</div>
<p>This is then used to create a list of states:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rds_client_double</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">rds_client_double</span><span class="o">.</span><span class="n">describe_db_instances</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;j&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;rebooting&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="s2">&quot;l&quot;</span><span class="p">}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="n">simple_instance_list</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="p">{}),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>These states are then used as returns from a mock object to ensure that the <code class="docutils literal notranslate"><span class="pre">await</span></code> function
waits through all of the states that would mean the RDS instance has not yet completed
configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rds_i</span><span class="o">.</span><span class="n">await_resource</span><span class="p">(</span><span class="n">rds_client_double</span><span class="p">,</span> <span class="s2">&quot;some-instance&quot;</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="n">mod_mock</span><span class="p">,</span>
                     <span class="n">await_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sleeper_double</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">),</span> <span class="s2">&quot;await_pending didn&#39;t wait enough&quot;</span>
</pre></div>
</div>
<p>By doing this we check that the <code class="docutils literal notranslate"><span class="pre">await</span></code> function will keep waiting through
potentially unusual that it would be impossible to reliably trigger through the
integration tests but which happen unpredictably in reality.</p>
</section>
<section id="defining-a-module-to-work-against-multiple-api-versions">
<h4><a class="toc-backref" href="#id16">Defining a module to work against multiple API versions</a><a class="headerlink" href="#defining-a-module-to-work-against-multiple-api-versions" title="Permalink to this headline"></a></h4>
<p>This case is especially important for modules interacting with many different versions of
software; for example, package installation modules that might be expected to work with
many different operating system versions.</p>
<p>By using previously stored data from various versions of an API we can ensure that the
code is tested against the actual data which will be sent from that version of the system
even when the version is very obscure and unlikely to be available during testing.</p>
</section>
</section>
</section>
<section id="ansible-special-cases-for-unit-testing">
<h2><a class="toc-backref" href="#id17">Ansible special cases for unit testing</a><a class="headerlink" href="#ansible-special-cases-for-unit-testing" title="Permalink to this headline"></a></h2>
<p>There are a number of special cases for unit testing the environment of an Ansible module.
The most common are documented below, and suggestions for others can be found by looking
at the source code of the existing unit tests or asking on the Ansible chat channel or mailing
lists. For more information on joining chat channels and subscribing to mailing lists, see <a class="reference internal" href="../community/communication.html#communication"><span class="std std-ref">Communicating with the Ansible community</span></a>.</p>
<section id="module-argument-processing">
<h3><a class="toc-backref" href="#id18">Module argument processing</a><a class="headerlink" href="#module-argument-processing" title="Permalink to this headline"></a></h3>
<p>There are two problems with running the main function of a module:</p>
<ul class="simple">
<li><p>Since the module is supposed to accept arguments on <code class="docutils literal notranslate"><span class="pre">STDIN</span></code> it is a bit difficult to
set up the arguments correctly so that the module will get them as parameters.</p></li>
<li><p>All modules should finish by calling either the <a class="reference internal" href="../api/index.html#module.fail_json" title="module.fail_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.fail_json()</span></code></a> or
<a class="reference internal" href="../api/index.html#module.exit_json" title="module.exit_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.exit_json()</span></code></a>, but these won’t work correctly in a testing environment.</p></li>
</ul>
</section>
<section id="passing-arguments">
<h3><a class="toc-backref" href="#id19">Passing Arguments</a><a class="headerlink" href="#passing-arguments" title="Permalink to this headline"></a></h3>
<p>To pass arguments to a module correctly, use the <code class="docutils literal notranslate"><span class="pre">set_module_args</span></code> method which accepts a dictionary
as its parameter. Module creation and argument processing is
handled through the <a class="reference internal" href="../api/index.html#AnsibleModule" title="AnsibleModule"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnsibleModule</span></code></a> object in the basic section of the utilities. Normally
this accepts input on <code class="docutils literal notranslate"><span class="pre">STDIN</span></code>, which is not convenient for unit testing. When the special
variable is set it will be treated as if the input came on <code class="docutils literal notranslate"><span class="pre">STDIN</span></code> to the module. Simply call that function before setting up your module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">units.modules.utils</span> <span class="kn">import</span> <span class="n">set_module_args</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils.common.text.converters</span> <span class="kn">import</span> <span class="n">to_bytes</span>

<span class="k">def</span> <span class="nf">test_already_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">set_module_args</span><span class="p">({</span>
        <span class="s1">&#39;activationkey&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;pass&#39;</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
</div>
</section>
<section id="handling-exit-correctly">
<h3><a class="toc-backref" href="#id20">Handling exit correctly</a><a class="headerlink" href="#handling-exit-correctly" title="Permalink to this headline"></a></h3>
<p>The <a class="reference internal" href="../api/index.html#module.exit_json" title="module.exit_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.exit_json()</span></code></a> function won’t work properly in a testing environment since it
writes error information to <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code> upon exit, where it
is difficult to examine. This can be mitigated by replacing it (and <a class="reference internal" href="../api/index.html#module.fail_json" title="module.fail_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.fail_json()</span></code></a>) with
a function that raises an exception:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exit_json</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;changed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">raise</span> <span class="n">AnsibleExitJson</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Now you can ensure that the first function called is the one you expected simply by
testing for the correct exception:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_returned_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">set_module_args</span><span class="p">({</span>
        <span class="s1">&#39;activationkey&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;pass&#39;</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleExitJson</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">my_module</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>The same technique can be used to replace <a class="reference internal" href="../api/index.html#module.fail_json" title="module.fail_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">module.fail_json()</span></code></a> (which is used for failure
returns from modules) and for the <code class="docutils literal notranslate"><span class="pre">aws_module.fail_json_aws()</span></code> (used in modules for Amazon
Web Services).</p>
</section>
<section id="running-the-main-function">
<h3><a class="toc-backref" href="#id21">Running the main function</a><a class="headerlink" href="#running-the-main-function" title="Permalink to this headline"></a></h3>
<p>If you do want to run the actual main function of a module you must import the module, set
the arguments as above, set up the appropriate exit exception and then run the module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This test is based around pytest&#39;s features for individual test functions</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">ansible.modules.module.group.my_module</span> <span class="k">as</span> <span class="nn">my_module</span>

<span class="k">def</span> <span class="nf">test_main_function</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">my_module</span><span class="o">.</span><span class="n">AnsibleModule</span><span class="p">,</span> <span class="s2">&quot;exit_json&quot;</span><span class="p">,</span> <span class="n">fake_exit_json</span><span class="p">)</span>
    <span class="n">set_module_args</span><span class="p">({</span>
        <span class="s1">&#39;activationkey&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;pass&#39;</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">my_module</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="handling-calls-to-external-executables">
<h3><a class="toc-backref" href="#id22">Handling calls to external executables</a><a class="headerlink" href="#handling-calls-to-external-executables" title="Permalink to this headline"></a></h3>
<p>Module must use <a class="reference internal" href="../api/index.html#AnsibleModule.run_command" title="AnsibleModule.run_command"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnsibleModule.run_command()</span></code></a> in order to execute an external command. This
method needs to be mocked:</p>
<p>Here is a simple mock of <a class="reference internal" href="../api/index.html#AnsibleModule.run_command" title="AnsibleModule.run_command"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AnsibleModule.run_command()</span></code></a> (taken from <code class="file docutils literal notranslate"><span class="pre">test/units/modules/packaging/os/test_rhn_register.py</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">AnsibleModule</span><span class="p">,</span> <span class="s1">&#39;run_command&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">run_command</span><span class="p">:</span>
    <span class="n">run_command</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># successful execution, no output</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleExitJson</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">my_module</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;changed&#39;</span><span class="p">])</span>
<span class="c1"># Check that run_command has been called</span>
<span class="n">run_command</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s1">&#39;/usr/bin/command args&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">run_command</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">run_command</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="a-complete-example">
<h3><a class="toc-backref" href="#id23">A Complete Example</a><a class="headerlink" href="#a-complete-example" title="Permalink to this headline"></a></h3>
<p>The following example is a complete skeleton that reuses the mocks explained above and adds a new
mock for <a class="reference internal" href="../api/index.html#Ansible.get_bin_path" title="Ansible.get_bin_path"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Ansible.get_bin_path()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">units.compat</span> <span class="kn">import</span> <span class="n">unittest</span>
<span class="kn">from</span> <span class="nn">units.compat.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils</span> <span class="kn">import</span> <span class="n">basic</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils.common.text.converters</span> <span class="kn">import</span> <span class="n">to_bytes</span>
<span class="kn">from</span> <span class="nn">ansible.modules.namespace</span> <span class="kn">import</span> <span class="n">my_module</span>


<span class="k">def</span> <span class="nf">set_module_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;prepare arguments so that they will be picked up during module creation&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;ANSIBLE_MODULE_ARGS&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
    <span class="n">basic</span><span class="o">.</span><span class="n">_ANSIBLE_ARGS</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AnsibleExitJson</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception class to be raised by module.exit_json and caught by the test case&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">AnsibleFailJson</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception class to be raised by module.fail_json and caught by the test case&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">exit_json</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function to patch over exit_json; package return data into an exception&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;changed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">raise</span> <span class="n">AnsibleExitJson</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fail_json</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function to patch over fail_json; package return data into an exception&quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">raise</span> <span class="n">AnsibleFailJson</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bin_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock AnsibleModule.get_bin_path&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;my_command&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;/usr/bin/my_command&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> not found !&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestMyModule</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_module_helper</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">multiple</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">AnsibleModule</span><span class="p">,</span>
                                                 <span class="n">exit_json</span><span class="o">=</span><span class="n">exit_json</span><span class="p">,</span>
                                                 <span class="n">fail_json</span><span class="o">=</span><span class="n">fail_json</span><span class="p">,</span>
                                                 <span class="n">get_bin_path</span><span class="o">=</span><span class="n">get_bin_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_module_helper</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mock_module_helper</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_module_fail_when_required_args_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleFailJson</span><span class="p">):</span>
            <span class="n">set_module_args</span><span class="p">({})</span>
            <span class="n">my_module</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">test_ensure_command_called</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">set_module_args</span><span class="p">({</span>
            <span class="s1">&#39;param1&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;param2&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">AnsibleModule</span><span class="p">,</span> <span class="s1">&#39;run_command&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_run_command</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="s1">&#39;configuration updated&#39;</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mock_run_command</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>  <span class="c1"># successful execution</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleExitJson</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">my_module</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;changed&#39;</span><span class="p">])</span> <span class="c1"># ensure result is changed</span>

        <span class="n">mock_run_command</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s1">&#39;/usr/bin/my_command --value 10 --name test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="restructuring-modules-to-enable-testing-module-set-up-and-other-processes">
<h3><a class="toc-backref" href="#id24">Restructuring modules to enable testing module set up and other processes</a><a class="headerlink" href="#restructuring-modules-to-enable-testing-module-set-up-and-other-processes" title="Permalink to this headline"></a></h3>
<p>Often modules have a <code class="docutils literal notranslate"><span class="pre">main()</span></code> function which sets up the module and then performs other
actions. This can make it difficult to check argument processing. This can be made easier by
moving module configuration and initialization into a separate function. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">argument_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1"># module function variables</span>
    <span class="n">state</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;absent&#39;</span><span class="p">,</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span> <span class="s1">&#39;rebooted&#39;</span><span class="p">,</span> <span class="s1">&#39;restarted&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;present&#39;</span><span class="p">),</span>
    <span class="n">apply_immediately</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">wait</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">wait_timeout</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">600</span><span class="p">),</span>
    <span class="n">allocated_storage</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]),</span>
    <span class="n">db_instance_identifier</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">setup_module_object</span><span class="p">():</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleAWSModule</span><span class="p">(</span>
        <span class="n">argument_spec</span><span class="o">=</span><span class="n">argument_spec</span><span class="p">,</span>
        <span class="n">required_if</span><span class="o">=</span><span class="n">required_if</span><span class="p">,</span>
        <span class="n">mutually_exclusive</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;old_instance_id&#39;</span><span class="p">,</span> <span class="s1">&#39;source_db_instance_identifier&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;db_snapshot_identifier&#39;</span><span class="p">]],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">module</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">setup_module_object</span><span class="p">()</span>
    <span class="n">validate_parameters</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">setup_client</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="n">run_task</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="o">**</span><span class="n">return_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>This now makes it possible to run tests against the module initiation function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_rds_module_setup_fails_if_db_instance_identifier_parameter_missing</span><span class="p">():</span>
    <span class="c1"># db_instance_identifier parameter is missing</span>
    <span class="n">set_module_args</span><span class="p">({</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;apply_immediately&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span>
     <span class="p">})</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AnsibleFailJson</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">my_module</span><span class="o">.</span><span class="n">setup_json</span>
</pre></div>
</div>
<p>See also <code class="docutils literal notranslate"><span class="pre">test/units/module_utils/aws/test_rds.py</span></code></p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">argument_spec</span></code> dictionary is visible in a module variable. This has
advantages, both in allowing explicit testing of the arguments and in allowing the easy
creation of module objects for testing.</p>
<p>The same restructuring technique can be valuable for testing other functionality, such as the part of the module which queries the object that the module configures.</p>
</section>
</section>
<section id="traps-for-maintaining-python-2-compatibility">
<h2><a class="toc-backref" href="#id25">Traps for maintaining Python 2 compatibility</a><a class="headerlink" href="#traps-for-maintaining-python-2-compatibility" title="Permalink to this headline"></a></h2>
<p>If you use the <code class="docutils literal notranslate"><span class="pre">mock</span></code> library from the Python 2.6 standard library, a number of the
assert functions are missing but will return as if successful. This means that test cases should take great care <em>not</em> use
functions marked as _new_ in the Python 3 documentation, since the tests will likely always
succeed even if the code is broken when run on older versions of Python.</p>
<p>A helpful development approach to this should be to ensure that all of the tests have been
run under Python 2.6 and that each assertion in the test cases has been checked to work by breaking
the code in Ansible to trigger that failure.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Maintain Python 2.6 compatibility</p>
<p>Please remember that modules need to maintain compatibility with Python 2.6 so the unittests for
modules should also be compatible with Python 2.6.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="testing_units.html#testing-units"><span class="std std-ref">Unit Tests</span></a></dt><dd><p>Ansible unit tests documentation</p>
</dd>
<dt><a class="reference internal" href="testing_running_locally.html#testing-running-locally"><span class="std std-ref">Testing Ansible</span></a></dt><dd><p>Running tests locally including gathering and reporting coverage data</p>
</dd>
<dt><a class="reference internal" href="developing_modules_general.html#developing-modules-general"><span class="std std-ref">Developing modules</span></a></dt><dd><p>Get started developing a module</p>
</dd>
<dt><a class="reference external" href="https://docs.python.org/3/library/unittest.html">Python 3 documentation - 26.4. unittest — Unit testing framework</a></dt><dd><p>The documentation of the unittest framework in python 3</p>
</dd>
<dt><a class="reference external" href="https://docs.python.org/3/library/unittest.html">Python 2 documentation - 25.3. unittest — Unit testing framework</a></dt><dd><p>The documentation of the earliest supported unittest framework - from Python 2.6</p>
</dd>
<dt><a class="reference external" href="https://docs.pytest.org/en/latest/">pytest: helps you write better programs</a></dt><dd><p>The documentation of pytest - the framework actually used to run Ansible unit tests</p>
</dd>
<dt><a class="reference external" href="https://groups.google.com/group/ansible-devel">Development Mailing List</a></dt><dd><p>Mailing list for development topics</p>
</dd>
<dt><a class="reference external" href="https://docs.python-guide.org/writing/tests/">Testing Your Code (from The Hitchhiker’s Guide to Python!)</a></dt><dd><p>General advice on testing Python code</p>
</dd>
<dt><a class="reference external" href="https://www.youtube.com/watch?v=QedpQjxBPMA&amp;list=PLlu0CT-JnSasQzGrGzddSczJQQU7295D2">Uncle Bob’s many videos on YouTube</a></dt><dd><p>Unit testing is a part of the of various philosophies of software development, including
Extreme Programming (XP), Clean Coding.  Uncle Bob talks through how to benefit from this</p>
</dd>
<dt><a class="reference external" href="https://rbcs-us.com/documents/Why-Most-Unit-Testing-is-Waste.pdf">“Why Most Unit Testing is Waste”</a></dt><dd><p>An article warning against the costs of unit testing</p>
</dd>
<dt><a class="reference external" href="https://henrikwarne.com/2014/09/04/a-response-to-why-most-unit-testing-is-waste/">‘A Response to “Why Most Unit Testing is Waste”’</a></dt><dd><p>An response pointing to how to maintain the value of unit tests</p>
</dd>
</dl>
</div>
</section>
</section>


           </div>
          </div>
          

<footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible project contributors.
      <span class="lastupdated">Last updated on Jun 27, 2022.
      </span></p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->
<!-- begin analytics -->
<script>
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
      (function(d,s,i,r) {
      if (d.getElementById(i)){return;}
      var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
      n.id=i;n.src = 'https://js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
      e.parentNode.insertBefore(n, e);
      })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script>
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
  _satellite.pageBottom();
}
</script>

</body>
</html>