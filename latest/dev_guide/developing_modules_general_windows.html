<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Windows module development walkthrough &mdash; Ansible Documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="_static/images/Ansible-Mark-RGB_Black.svg"/>
    <link rel="canonical" href="https://docs.ansible.com/ansible/latest/dev_guide/developing_modules_general_windows.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Developing Cisco ACI modules" href="developing_modules_general_aci.html" />
    <link rel="prev" title="Module format and documentation" href="developing_modules_documenting.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->
<script src="https://www.redhat.com/dtm.js"></script>


<!-- <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> -->
<meta class="swiftype" name="version" data-type="string" content="6">

<!-- Google Tag Manager Data Layer -->
<script>
 dataLayer = [];
</script>
<!-- End Google Tag Manager Data Layer -->



<script>
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','https://s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->
<!-- Google Tag Manager -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
<!-- End Google Tag Manager -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/Ansible-Mark-RGB_White.svg"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Ansible
          </a>
              <div class="version">
                6
              </div><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    <div class="version-dropdown">
      <script>
        function switchVersionTo(slug) {
          var current_url_path = window.location.pathname;
          var url_version = current_url_path.search("/6/") > -1
            ? "/6/"
            : "/latest/";
          var new_version_url = current_url_path.replace(url_version, "/" + slug + "/");
          window.location.replace(new_version_url);
        }
      </script>
      <select
          class="version-list"
          id="version-list"
          onchange="switchVersionTo(this.value);"
      >
        
        <option
            value="latest"
            
        >
            latest
        </option>
        
        <option
            value="2.9"
            
        >
            2.9
        </option>
        
        <option
            value="devel"
            
        >
            devel
        </option>
        
      </select>
    </div>
  
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Ansible getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started with Ansible</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation, Upgrade &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_guide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting_guides/porting_guides.html">Ansible Porting Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Ansible Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions_collections.html">Ansible Collections Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions.html">ansible-core Contributors Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/advanced_index.html">Advanced Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="style_guide/index.html">Ansible documentation style guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Ansible</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="developing_locally.html">Adding modules and plugins locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules.html">Should you develop a module?</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_general.html">Developing modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_checklist.html">Contributing your module to an existing Ansible collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_best_practices.html">Conventions, tips, and pitfalls</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_python_3.html">Ansible and Python 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_documenting.html">Module format and documentation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Windows module development walkthrough</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#windows-environment-setup">Windows environment setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-windows-server-in-a-vm">Create a Windows server in a VM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-an-ansible-inventory">Create an Ansible inventory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#provisioning-the-environment">Provisioning the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-new-module-development">Windows new module development</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-module-utilities">Windows module utilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exposing-shared-module-options">Exposing shared module options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#windows-playbook-module-testing">Windows playbook module testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-debugging">Windows debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-unit-testing">Windows unit testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-integration-testing">Windows integration testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows-communication-and-development-support">Windows communication and development support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_general_aci.html">Developing Cisco ACI modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="platforms/aws_guidelines.html">Guidelines for Ansible Amazon AWS module development</a></li>
<li class="toctree-l2"><a class="reference internal" href="platforms/openstack_guidelines.html">OpenStack Ansible Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="platforms/ovirt_dev_guide.html">oVirt Ansible Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="platforms/vmware_guidelines.html">Guidelines for VMware module development</a></li>
<li class="toctree-l2"><a class="reference internal" href="platforms/vmware_rest_guidelines.html">Guidelines for VMware REST module development</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_modules_in_groups.html">Creating a new collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="module_lifecycle.html">The lifecycle of an Ansible module or plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_plugins.html">Developing plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_inventory.html">Developing dynamic inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_core.html">Developing <code class="docutils literal notranslate"><span class="pre">ansible-core</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_program_flow_modules.html">Ansible module architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_api.html">Python API</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_rebasing.html">Rebasing a pull request</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_module_utilities.html">Using and developing module utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="developing_collections.html">Developing collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating_roles.html">Migrating Roles to Roles in Collections on Galaxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="collections_galaxy_meta.html">Collection Galaxy metadata structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview_architecture.html">Ansible architecture</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Ansible Scenarios</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/cloud_guides.html">Legacy Public Cloud Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/network_guides.html">Network Technology Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/virt_guides.html">Virtualization and Containerization Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Automation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/getting_started/index.html">Network Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/user_guide/index.html">Network Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dev_guide/index.html">Network Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ansible Galaxy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/user_guide.html">Galaxy User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/dev_guide.html">Galaxy Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference &amp; Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collections/index.html">Collection Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collections/all_plugins.html">Indexes of all modules and plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/playbooks_keywords.html">Playbook Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/common_return_values.html">Return Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/config.html">Ansible Configuration Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/general_precedence.html">Controlling how Ansible behaves: precedence rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/YAMLSyntax.html">YAML Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/python_3_support.html">Python 3 Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/interpreter_discovery.html">Interpreter Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/release_and_maintenance.html">Releases and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/test_strategies.html">Testing Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing/sanity/index.html">Sanity Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/module_utils.html">Ansible Reference: Module Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/special_variables.html">Special Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/tower.html">Red Hat Ansible Automation Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/automationhub.html">Ansible Automation Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/logging.html">Logging Ansible output</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Roadmaps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_roadmap_index.html">Ansible Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_core_roadmap_index.html">ansible-core Roadmaps</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->
<!-- changeable widget links to tower - do not change as image controlled by Ansible-->
<div id="sideBanner">
  <br/>
  <a href="https://www.ansible.com/docs-left?utm_source=docs">
    <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
  </a>
  <br/><br/><br/>
</div>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Developer Guide</a> &raquo;</li>
      <li>Windows module development walkthrough</li>
  <li class="wy-breadcrumbs-aside">
          <!-- Ansible-specific additions for modules etc -->
            
              <a href="https://github.com/ansible/ansible/edit/devel/docs/docsite/rst/dev_guide/developing_modules_general_windows.rst?description=%23%23%23%23%23%20SUMMARY%0A%3C!---%20Your%20description%20here%20--%3E%0A%0A%0A%23%23%23%23%23%20ISSUE%20TYPE%0A-%20Docs%20Pull%20Request%0A%0A%2Blabel:%20docsite_pr" class="fa fa-github"> Edit on GitHub</a>
            
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  <script>
    function startsWith(str, needle) {
      return str.slice(0, needle.length) == needle
    }
    function startsWithOneOf(str, needles) {
      return needles.some(function (needle) {
        return startsWith(str, needle);
      });
    }
    var banner = '';
      var extra_banner = '';
    /*use extra_banner for when marketing wants something extra, like a survey or AnsibleFest notice
    var extra_banner =
      '<div id="latest_extra_banner_id" class="admonition important">' +
      '<br>' +
      '<p>' +
        'You\'re invited to AnsibleFest 2021! ' +
      '<p>' +
        'Explore ways to automate, innovate, and accelerate with our free virtual event September 29-30. ' +
      '<pr>' +
        '<a href="https://reg.ansiblefest.redhat.com/flow/redhat/ansible21/regGenAttendee/login?sc_cid=7013a000002pemAAAQ">Register now!</a> ' +
      '</p>' +
      '<br>' +
      '</div>'; */
    // Create a banner if we're not on the official docs site
    if (location.host == "docs.testing.ansible.com") {
      document.write('<div id="testing_banner_id" class="admonition important">' +
                     '<p>This is the testing site for Ansible Documentation. Unless you are reviewing pre-production changes, please visit the <a href="https://docs.ansible.com/ansible/latest/">official documentation website</a>.</p> <p></p>' +
                     '</div>');
    }
    
      // Create a banner
      current_url_path = window.location.pathname;

      var important = false;
      var msg = '<p>';
      if (startsWith(current_url_path, "/ansible-core/")) {
        msg += 'You are reading documentation for Ansible Core, which contains no plugins except for those in ansible.builtin. For documentation of the Ansible package, go to <a href="/ansible/latest">the latest documentation</a>.';
      } else if (startsWithOneOf(current_url_path, ["/ansible/latest/", "/ansible/6/"])) {
        /* temp extra banner to advertise AnsibeFest2021 */
        banner += extra_banner;

        msg += 'You are reading the <b>latest</b> (stable) community version of the Ansible documentation. Red Hat subscribers, select <b>2.9</b> in the version selection to the left for the most recent Red Hat release.';
      } else if (startsWith(current_url_path, "/ansible/2.9/")) {
        msg += 'You are reading the latest Red Hat released version of the Ansible documentation. Community users can use this version, or select <b>latest</b> from the version selector to the left for the most recent community version.';
      } else if (startsWith(current_url_path, "/ansible/devel/")) {
        /* temp extra banner to advertise AnsibleFest2021 */
        banner += extra_banner;

        /* temp banner to advertise survey
        important = true;
        msg += 'Please take our <a href="https://www.surveymonkey.co.uk/r/B9V3CDY">Docs survey</a> before December 31 to help us improve Ansible documentation.';
        */

        msg += 'You are reading the <b>devel</b> version of the Ansible documentation - this version is not guaranteed stable. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
      } else {
        msg += 'You are reading an older version of the Ansible documentation. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
      }
      msg += '</p>';

      banner += '<div id="banner_id" class="admonition ';
      banner += important ? 'important' : 'caution';
      banner += '">';
      banner += important ? '<br>' : '';
      banner += msg;
      banner += important ? '<br>' : '';
      banner += '</div>';
      document.write(banner);
    
  </script>


  
           <div itemprop="articleBody">
             
  <section id="windows-module-development-walkthrough">
<span id="developing-modules-general-windows"></span><h1>Windows module development walkthrough<a class="headerlink" href="#windows-module-development-walkthrough" title="Permalink to this headline"></a></h1>
<p>In this section, we will walk through developing, testing, and debugging an
Ansible Windows module.</p>
<p>Because Windows modules are written in Powershell and need to be run on a
Windows host, this guide differs from the usual development walkthrough guide.</p>
<p>What’s covered in this section:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#windows-environment-setup" id="id1">Windows environment setup</a></p></li>
<li><p><a class="reference internal" href="#create-a-windows-server-in-a-vm" id="id2">Create a Windows server in a VM</a></p></li>
<li><p><a class="reference internal" href="#create-an-ansible-inventory" id="id3">Create an Ansible inventory</a></p></li>
<li><p><a class="reference internal" href="#provisioning-the-environment" id="id4">Provisioning the environment</a></p></li>
<li><p><a class="reference internal" href="#windows-new-module-development" id="id5">Windows new module development</a></p></li>
<li><p><a class="reference internal" href="#windows-module-utilities" id="id6">Windows module utilities</a></p>
<ul>
<li><p><a class="reference internal" href="#exposing-shared-module-options" id="id7">Exposing shared module options</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#windows-playbook-module-testing" id="id8">Windows playbook module testing</a></p></li>
<li><p><a class="reference internal" href="#windows-debugging" id="id9">Windows debugging</a></p></li>
<li><p><a class="reference internal" href="#windows-unit-testing" id="id10">Windows unit testing</a></p></li>
<li><p><a class="reference internal" href="#windows-integration-testing" id="id11">Windows integration testing</a></p></li>
<li><p><a class="reference internal" href="#windows-communication-and-development-support" id="id12">Windows communication and development support</a></p></li>
</ul>
</div>
<section id="windows-environment-setup">
<h2><a class="toc-backref" href="#id1">Windows environment setup</a><a class="headerlink" href="#windows-environment-setup" title="Permalink to this headline"></a></h2>
<p>Unlike Python module development which can be run on the host that runs
Ansible, Windows modules need to be written and tested for Windows hosts.
While evaluation editions of Windows can be downloaded from
Microsoft, these images are usually not ready to be used by Ansible without
further modification. The easiest way to set up a Windows host so that it is
ready to by used by Ansible is to set up a virtual machine using Vagrant.
Vagrant can be used to download existing OS images called <em>boxes</em> that are then
deployed to a hypervisor like VirtualBox. These boxes can either be created and
stored offline or they can be downloaded from a central repository called
Vagrant Cloud.</p>
<p>This guide will use the Vagrant boxes created by the <a class="reference external" href="https://github.com/jborean93/packer-windoze">packer-windoze</a>
repository which have also been uploaded to <a class="reference external" href="https://app.vagrantup.com/boxes/search?utf8=%E2%9C%93&amp;sort=downloads&amp;provider=&amp;q=jborean93">Vagrant Cloud</a>.
To find out more info on how these images are created, please go to the GitHub
repo and look at the <code class="docutils literal notranslate"><span class="pre">README</span></code> file.</p>
<p>Before you can get started, the following programs must be installed (please consult the Vagrant and
VirtualBox documentation for installation instructions):</p>
<ul class="simple">
<li><p>Vagrant</p></li>
<li><p>VirtualBox</p></li>
</ul>
</section>
<section id="create-a-windows-server-in-a-vm">
<h2><a class="toc-backref" href="#id2">Create a Windows server in a VM</a><a class="headerlink" href="#create-a-windows-server-in-a-vm" title="Permalink to this headline"></a></h2>
<p>To create a single Windows Server 2016 instance, run the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>vagrant init jborean93/WindowsServer2016
vagrant up
</pre></div>
</div>
<p>This will download the Vagrant box from Vagrant Cloud and add it to the local
boxes on your host and then start up that instance in VirtualBox. When starting
for the first time, the Windows VM will run through the sysprep process and
then create a HTTP and HTTPS WinRM listener automatically. Vagrant will finish
its process once the listeners are online, after which the VM can be used by Ansible.</p>
</section>
<section id="create-an-ansible-inventory">
<h2><a class="toc-backref" href="#id3">Create an Ansible inventory</a><a class="headerlink" href="#create-an-ansible-inventory" title="Permalink to this headline"></a></h2>
<p>The following Ansible inventory file can be used to connect to the newly
created Windows VM:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[windows]</span>
<span class="na">WindowsServer  ansible_host</span><span class="o">=</span><span class="s">127.0.0.1</span>

<span class="k">[windows:vars]</span>
<span class="na">ansible_user</span><span class="o">=</span><span class="s">vagrant</span>
<span class="na">ansible_password</span><span class="o">=</span><span class="s">vagrant</span>
<span class="na">ansible_port</span><span class="o">=</span><span class="s">55986</span>
<span class="na">ansible_connection</span><span class="o">=</span><span class="s">winrm</span>
<span class="na">ansible_winrm_transport</span><span class="o">=</span><span class="s">ntlm</span>
<span class="na">ansible_winrm_server_cert_validation</span><span class="o">=</span><span class="s">ignore</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The port <code class="docutils literal notranslate"><span class="pre">55986</span></code> is automatically forwarded by Vagrant to the
Windows host that was created, if this conflicts with an existing local
port then Vagrant will automatically use another one at random and display
show that in the output.</p>
</div>
<p>The OS that is created is based on the image set. The following
images can be used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://app.vagrantup.com/jborean93/boxes/WindowsServer2012">jborean93/WindowsServer2012</a></p></li>
<li><p><a class="reference external" href="https://app.vagrantup.com/jborean93/boxes/WindowsServer2012R2">jborean93/WindowsServer2012R2</a></p></li>
<li><p><a class="reference external" href="https://app.vagrantup.com/jborean93/boxes/WindowsServer2016">jborean93/WindowsServer2016</a></p></li>
<li><p><a class="reference external" href="https://app.vagrantup.com/jborean93/boxes/WindowsServer2019">jborean93/WindowsServer2019</a></p></li>
<li><p><a class="reference external" href="https://app.vagrantup.com/jborean93/boxes/WindowsServer2022">jborean93/WindowsServer2022</a></p></li>
</ul>
<p>When the host is online, it can accessible by RDP on <code class="docutils literal notranslate"><span class="pre">127.0.0.1:3389</span></code> but the
port may differ depending if there was a conflict. To get rid of the host, run
<code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">destroy</span> <span class="pre">--force</span></code> and Vagrant will automatically remove the VM and
any other files associated with that VM.</p>
<p>While this is useful when testing modules on a single Windows instance, these
host won’t work without modification with domain based modules. The Vagrantfile
at <a class="reference external" href="https://github.com/jborean93/ansible-windows/tree/master/vagrant">ansible-windows</a>
can be used to create a test domain environment to be used in Ansible. This
repo contains three files which are used by both Ansible and Vagrant to create
multiple Windows hosts in a domain environment. These files are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>: The Vagrant file that reads the inventory setup of <code class="docutils literal notranslate"><span class="pre">inventory.yml</span></code> and provisions the hosts that are required</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inventory.yml</span></code>: Contains the hosts that are required and other connection information such as IP addresses and forwarded ports</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">main.yml</span></code>: Ansible playbook called by Vagrant to provision the domain controller and join the child hosts to the domain</p></li>
</ul>
<p>By default, these files will create the following environment:</p>
<ul class="simple">
<li><p>A single domain controller running on Windows Server 2016</p></li>
<li><p>Five child hosts for each major Windows Server version joined to that domain</p></li>
<li><p>A domain with the DNS name <code class="docutils literal notranslate"><span class="pre">domain.local</span></code></p></li>
<li><p>A local administrator account on each host with the username <code class="docutils literal notranslate"><span class="pre">vagrant</span></code> and password <code class="docutils literal notranslate"><span class="pre">vagrant</span></code></p></li>
<li><p>A domain admin account <code class="docutils literal notranslate"><span class="pre">vagrant-domain&#64;domain.local</span></code> with the password <code class="docutils literal notranslate"><span class="pre">VagrantPass1</span></code></p></li>
</ul>
<p>The domain name and accounts can be modified by changing the variables
<code class="docutils literal notranslate"><span class="pre">domain_*</span></code> in the <code class="docutils literal notranslate"><span class="pre">inventory.yml</span></code> file if it is required. The inventory
file can also be modified to provision more or less servers by changing the
hosts that are defined under the <code class="docutils literal notranslate"><span class="pre">domain_children</span></code> key. The host variable
<code class="docutils literal notranslate"><span class="pre">ansible_host</span></code> is the private IP that will be assigned to the VirtualBox host
only network adapter while <code class="docutils literal notranslate"><span class="pre">vagrant_box</span></code> is the box that will be used to
create the VM.</p>
</section>
<section id="provisioning-the-environment">
<h2><a class="toc-backref" href="#id4">Provisioning the environment</a><a class="headerlink" href="#provisioning-the-environment" title="Permalink to this headline"></a></h2>
<p>To provision the environment as is, run the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/jborean93/ansible-windows.git
<span class="nb">cd</span> vagrant
vagrant up
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Vagrant provisions each host sequentially so this can take some time
to complete. If any errors occur during the Ansible phase of setting up the
domain, run <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">provision</span></code> to rerun just that step.</p>
</div>
<p>Unlike setting up a single Windows instance with Vagrant, these hosts can also
be accessed using the IP address directly as well as through the forwarded
ports. It is easier to access it over the host only network adapter as the
normal protocol ports are used, for example RDP is still over <code class="docutils literal notranslate"><span class="pre">3389</span></code>. In cases where
the host cannot be resolved using the host only network IP, the following
protocols can be access over <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> using these forwarded ports:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RDP</span></code>: 295xx</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SSH</span></code>: 296xx</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WinRM</span> <span class="pre">HTTP</span></code>: 297xx</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WinRM</span> <span class="pre">HTTPS</span></code>: 298xx</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SMB</span></code>: 299xx</p></li>
</ul>
<p>Replace <code class="docutils literal notranslate"><span class="pre">xx</span></code> with the entry number in the inventory file where the domain
controller started with <code class="docutils literal notranslate"><span class="pre">00</span></code> and is incremented from there. For example, in
the default <code class="docutils literal notranslate"><span class="pre">inventory.yml</span></code> file, WinRM over HTTPS for <code class="docutils literal notranslate"><span class="pre">SERVER2012R2</span></code> is
forwarded over port <code class="docutils literal notranslate"><span class="pre">29804</span></code> as it’s the fourth entry in <code class="docutils literal notranslate"><span class="pre">domain_children</span></code>.</p>
</section>
<section id="windows-new-module-development">
<h2><a class="toc-backref" href="#id5">Windows new module development</a><a class="headerlink" href="#windows-new-module-development" title="Permalink to this headline"></a></h2>
<p>When creating a new module there are a few things to keep in mind:</p>
<ul class="simple">
<li><p>Module code is in Powershell (.ps1) files while the documentation is contained in Python (.py) files of the same name</p></li>
<li><p>Avoid using <code class="docutils literal notranslate"><span class="pre">Write-Host/Debug/Verbose/Error</span></code> in the module and add what needs to be returned to the <code class="docutils literal notranslate"><span class="pre">$module.Result</span></code> variable</p></li>
<li><p>To fail a module, call <code class="docutils literal notranslate"><span class="pre">$module.FailJson(&quot;failure</span> <span class="pre">message</span> <span class="pre">here&quot;)</span></code>, an Exception or ErrorRecord can be set to the second argument for a more descriptive error message</p></li>
<li><p>You can pass in the exception or ErrorRecord as a second argument to <code class="docutils literal notranslate"><span class="pre">FailJson(&quot;failure&quot;,</span> <span class="pre">$_)</span></code> to get a more detailed output</p></li>
<li><p>Most new modules require check mode and integration tests before they are merged into the main Ansible codebase</p></li>
<li><p>Avoid using try/catch statements over a large code block, rather use them for individual calls so the error message can be more descriptive</p></li>
<li><p>Try and catch specific exceptions when using try/catch statements</p></li>
<li><p>Avoid using PSCustomObjects unless necessary</p></li>
<li><p>Look for common functions in <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/powershell/</span></code> and use the code there instead of duplicating work. These can be imported by adding the line <code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span> <span class="pre">*</span></code> where * is the filename to import, and will be automatically included with the module code sent to the Windows target when run via Ansible</p></li>
<li><p>As well as PowerShell module utils, C# module utils are stored in <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/csharp/</span></code> and are automatically imported in a module execution if the line <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-CSharpUtil</span> <span class="pre">*</span></code> is present</p></li>
<li><p>C# and PowerShell module utils achieve the same goal but C# allows a developer to implement low level tasks, such as calling the Win32 API, and can be faster in some cases</p></li>
<li><p>Ensure the code runs under Powershell v3 and higher on Windows Server 2012 and higher; if higher minimum Powershell or OS versions are required, ensure the documentation reflects this clearly</p></li>
<li><p>Ansible runs modules under strictmode version 2.0. Be sure to test with that enabled by putting <code class="docutils literal notranslate"><span class="pre">Set-StrictMode</span> <span class="pre">-Version</span> <span class="pre">2.0</span></code> at the top of your dev script</p></li>
<li><p>Favor native Powershell cmdlets over executable calls if possible</p></li>
<li><p>Use the full cmdlet name instead of aliases, for example <code class="docutils literal notranslate"><span class="pre">Remove-Item</span></code> over <code class="docutils literal notranslate"><span class="pre">rm</span></code></p></li>
<li><p>Use named parameters with cmdlets, for example <code class="docutils literal notranslate"><span class="pre">Remove-Item</span> <span class="pre">-Path</span> <span class="pre">C:\temp</span></code> over <code class="docutils literal notranslate"><span class="pre">Remove-Item</span> <span class="pre">C:\temp</span></code></p></li>
</ul>
<p>A very basic Powershell module <a class="reference external" href="https://github.com/ansible-collections/ansible.windows/blob/master/plugins/modules/win_environment.ps1">win_environment</a> incorporates best practices for Powershell modules. It demonstrates how to implement check-mode and diff-support, and also shows a warning to the user when a specific condition is met.</p>
<p>A slightly more advanced module is <a class="reference external" href="https://github.com/ansible-collections/ansible.windows/blob/master/plugins/modules/win_uri.ps1">win_uri</a> which additionally shows how to use different parameter types (bool, str, int, list, dict, path) and a selection of choices for parameters, how to fail a module and how to handle exceptions.</p>
<p>As part of the new <code class="docutils literal notranslate"><span class="pre">AnsibleModule</span></code> wrapper, the input parameters are defined and validated based on an argument
spec. The following options can be set at the root level of the argument spec:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mutually_exclusive</span></code>: A list of lists, where the inner list contains module options that cannot be set together</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">no_log</span></code>: Stops the module from emitting any logs to the Windows Event log</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">options</span></code>: A dictionary where the key is the module option and the value is the spec for that option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_by</span></code>: A dictionary where the option(s) specified by the value must be set if the option specified by the key is also set</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">required_if</span></code>: A list of lists where the inner list contains 3 or 4 elements;</dt><dd><ul>
<li><p>The first element is the module option to check the value against</p></li>
<li><p>The second element is the value of the option specified by the first element, if matched then the required if check is run</p></li>
<li><p>The third element is a list of required module options when the above is matched</p></li>
<li><p>An optional fourth element is a boolean that states whether all module options in the third elements are required (default: <code class="docutils literal notranslate"><span class="pre">$false</span></code>) or only one (<code class="docutils literal notranslate"><span class="pre">$true</span></code>)</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_one_of</span></code>: A list of lists, where the inner list contains module options where at least one must be set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_together</span></code>: A list of lists, where the inner list contains module options that must be set together</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">supports_check_mode</span></code>: Whether the module supports check mode, by default this is <code class="docutils literal notranslate"><span class="pre">$false</span></code></p></li>
</ul>
<p>The actual input options for a module are set within the <code class="docutils literal notranslate"><span class="pre">options</span></code> value as a dictionary. The keys of this dictionary
are the module option names while the values are the spec of that module option. Each spec can have the following
options set:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aliases</span></code>: A list of aliases for the module option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">choices</span></code>: A list of valid values for the module option, if <code class="docutils literal notranslate"><span class="pre">type=list</span></code> then each list value is validated against the choices and not the list itself</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code>: The default value for the module option if not set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deprecated_aliases</span></code>: A list of hashtables that define aliases that are deprecated and the versions they will be removed in. Each entry must contain the keys <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">collection_name</span></code> with either <code class="docutils literal notranslate"><span class="pre">version</span></code> or <code class="docutils literal notranslate"><span class="pre">date</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">elements</span></code>: When <code class="docutils literal notranslate"><span class="pre">type=list</span></code>, this sets the type of each list value, the values are the same as <code class="docutils literal notranslate"><span class="pre">type</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">no_log</span></code>: Will sanitise the input value before being returned in the <code class="docutils literal notranslate"><span class="pre">module_invocation</span></code> return value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">removed_in_version</span></code>: States when a deprecated module option is to be removed, a warning is displayed to the end user if set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">removed_at_date</span></code>: States the date (YYYY-MM-DD) when a deprecated module option will be removed, a warning is displayed to the end user if set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">removed_from_collection</span></code>: States from which collection the deprecated module option will be removed; must be specified if one of <code class="docutils literal notranslate"><span class="pre">removed_in_version</span></code> and <code class="docutils literal notranslate"><span class="pre">removed_at_date</span></code> is specified</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required</span></code>: Will fail when the module option is not set</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code>: The type of the module option, if not set then it defaults to <code class="docutils literal notranslate"><span class="pre">str</span></code>. The valid types are;</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span></code>: A boolean value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dict</span></code>: A dictionary value, if the input is a JSON or key=value string then it is converted to dictionary</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">float</span></code>: A float or <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/api/system.single?view=netframework-4.7.2">Single</a> value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span></code>: An Int32 value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">json</span></code>: A string where the value is converted to a JSON string if the input is a dictionary</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">list</span></code>: A list of values, <code class="docutils literal notranslate"><span class="pre">elements=&lt;type&gt;</span></code> can convert the individual list value types if set. If <code class="docutils literal notranslate"><span class="pre">elements=dict</span></code> then <code class="docutils literal notranslate"><span class="pre">options</span></code> is defined, the values will be validated against the argument spec. When the input is a string then the string is split by <code class="docutils literal notranslate"><span class="pre">,</span></code> and any whitespace is trimmed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path</span></code>: A string where values likes <code class="docutils literal notranslate"><span class="pre">%TEMP%</span></code> are expanded based on environment values. If the input value starts with <code class="docutils literal notranslate"><span class="pre">\\?\</span></code> then no expansion is run</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw</span></code>: No conversions occur on the value passed in by Ansible</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sid</span></code>: Will convert Windows security identifier values or Windows account names to a <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/api/system.security.principal.securityidentifier?view=netframework-4.7.2">SecurityIdentifier</a> value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">str</span></code>: The value is converted to a string</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>When <code class="docutils literal notranslate"><span class="pre">type=dict</span></code>, or <code class="docutils literal notranslate"><span class="pre">type=list</span></code> and <code class="docutils literal notranslate"><span class="pre">elements=dict</span></code>, the following keys can also be set for that module option:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply_defaults</span></code>: The value is based on the <code class="docutils literal notranslate"><span class="pre">options</span></code> spec defaults for that key if <code class="docutils literal notranslate"><span class="pre">True</span></code> and null if <code class="docutils literal notranslate"><span class="pre">False</span></code>. Only valid when the module option is not defined by the user and <code class="docutils literal notranslate"><span class="pre">type=dict</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mutually_exclusive</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">mutually_exclusive</span></code> but validated against the values in the sub dict</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">options</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">options</span></code> but contains the valid options for the sub option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_if</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">required_if</span></code> but validated against the values in the sub dict</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_by</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">required_by</span></code> but validated against the values in the sub dict</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_together</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">required_together</span></code> but validated against the values in the sub dict</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_one_of</span></code>: Same as the root level <code class="docutils literal notranslate"><span class="pre">required_one_of</span></code> but validated against the values in the sub dict</p></li>
</ul>
<p>A module type can also be a delegate function that converts the value to whatever is required by the module option. For
example the following snippet shows how to create a custom type that creates a <code class="docutils literal notranslate"><span class="pre">UInt64</span></code> value:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$spec</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">uint64_type</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="no">[Func[[Object], [UInt64]]]</span><span class="p">{</span> <span class="no">[System.UInt64]</span><span class="p">::</span><span class="n">Parse</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$uint64_type</span> <span class="p">=</span> <span class="nv">$module</span><span class="p">.</span><span class="n">Params</span><span class="p">.</span><span class="n">uint64_type</span>
</pre></div>
</div>
<p>When in doubt, look at some of the other core modules and see how things have been
implemented there.</p>
<p>Sometimes there are multiple ways that Windows offers to complete a task; this
is the order to favor when writing modules:</p>
<ul class="simple">
<li><p>Native Powershell cmdlets like <code class="docutils literal notranslate"><span class="pre">Remove-Item</span> <span class="pre">-Path</span> <span class="pre">C:\temp</span> <span class="pre">-Recurse</span></code></p></li>
<li><p>.NET classes like <code class="docutils literal notranslate"><span class="pre">[System.IO.Path]::GetRandomFileName()</span></code></p></li>
<li><p>WMI objects through the <code class="docutils literal notranslate"><span class="pre">New-CimInstance</span></code> cmdlet</p></li>
<li><p>COM objects through <code class="docutils literal notranslate"><span class="pre">New-Object</span> <span class="pre">-ComObject</span></code> cmdlet</p></li>
<li><p>Calls to native executables like <code class="docutils literal notranslate"><span class="pre">Secedit.exe</span></code></p></li>
</ul>
<p>PowerShell modules support a small subset of the <code class="docutils literal notranslate"><span class="pre">#Requires</span></code> options built
into PowerShell as well as some Ansible-specific requirements specified by
<code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span></code>. These statements can be placed at any point in the script,
but are most commonly near the top. They are used to make it easier to state the
requirements of the module without writing any of the checks. Each <code class="docutils literal notranslate"><span class="pre">requires</span></code>
statement must be on its own line, but there can be multiple requires statements
in one script.</p>
<p>These are the checks that can be used within Ansible modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span> <span class="pre">Ansible.ModuleUtils.&lt;module_util&gt;</span></code>: Added in Ansible 2.4, specifies a module_util to load in for the module execution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Version</span> <span class="pre">x.y</span></code>: Added in Ansible 2.5, specifies the version of PowerShell that is required by the module. The module will fail if this requirement is not met.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-PowerShell</span> <span class="pre">&lt;module_util&gt;</span></code>: Added in Ansible 2.8, like <code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span></code>, this specifies a module_util to load in for module execution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-CSharpUtil</span> <span class="pre">&lt;module_util&gt;</span></code>: Added in Ansible 2.8, specifies a C# module_util to load in for the module execution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-OSVersion</span> <span class="pre">x.y</span></code>: Added in Ansible 2.5, specifies the OS build version that is required by the module and will fail if this requirement is not met. The actual OS version is derived from <code class="docutils literal notranslate"><span class="pre">[Environment]::OSVersion.Version</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-Become</span></code>: Added in Ansible 2.5, forces the exec runner to run the module with <code class="docutils literal notranslate"><span class="pre">become</span></code>, which is primarily used to bypass WinRM restrictions. If <code class="docutils literal notranslate"><span class="pre">ansible_become_user</span></code> is not specified then the <code class="docutils literal notranslate"><span class="pre">SYSTEM</span></code> account is used instead.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-PowerShell</span></code> and <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-CSharpUtil</span></code>
support further features such as:</p>
<ul class="simple">
<li><p>Importing a util contained in a collection (added in Ansible 2.9)</p></li>
<li><p>Importing a util by relative names (added in Ansible 2.10)</p></li>
<li><p>Specifying the util is optional by adding <cite>-Optional</cite> to the import
declaration (added in Ansible 2.12).</p></li>
</ul>
<p>See the below examples for more details:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Imports the PowerShell Ansible.ModuleUtils.Legacy provided by Ansible itself</span>
<span class="c">#AnsibleRequires -PowerShell Ansible.ModuleUtils.Legacy</span>

<span class="c"># Imports the PowerShell my_util in the my_namesapce.my_name collection</span>
<span class="c">#AnsibleRequires -PowerShell ansible_collections.my_namespace.my_name.plugins.module_utils.my_util</span>

<span class="c"># Imports the PowerShell my_util that exists in the same collection as the current module</span>
<span class="c">#AnsibleRequires -PowerShell ..module_utils.my_util</span>

<span class="c"># Imports the PowerShell Ansible.ModuleUtils.Optional provided by Ansible if it exists.</span>
<span class="c"># If it does not exist then it will do nothing.</span>
<span class="c">#AnsibleRequires -PowerShell Ansible.ModuleUtils.Optional -Optional</span>

<span class="c"># Imports the C# Ansible.Process provided by Ansible itself</span>
<span class="c">#AnsibleRequires -CSharpUtil Ansible.Process</span>

<span class="c"># Imports the C# my_util in the my_namespace.my_name collection</span>
<span class="c">#AnsibleRequires -CSharpUtil ansible_collections.my_namespace.my_name.plugins.module_utils.my_util</span>

<span class="c"># Imports the C# my_util that exists in the same collection as the current module</span>
<span class="c">#AnsibleRequires -CSharpUtil ..module_utils.my_util</span>

<span class="c"># Imports the C# Ansible.Optional provided by Ansible if it exists.</span>
<span class="c"># If it does not exist then it will do nothing.</span>
<span class="c">#AnsibleRequires -CSharpUtil Ansible.Optional -Optional</span>
</pre></div>
</div>
<p>For optional require statements, it is up to the module code to then verify
whether the util has been imported before trying to use it. This can be done by
checking if a function or type provided by the util exists or not.</p>
<p>While both <code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span></code> and <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span> <span class="pre">-PowerShell</span></code> can be
used to load a PowerShell module it is recommended to use <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span></code>.
This is because <code class="docutils literal notranslate"><span class="pre">#AnsibleRequires</span></code> supports collection module utils, imports
by relative util names, and optional util imports.</p>
<p>C# module utils can reference other C# utils by adding the line
<code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">Ansible.&lt;module_util&gt;;</span></code> to the top of the script with all the other
using statements.</p>
</section>
<section id="windows-module-utilities">
<h2><a class="toc-backref" href="#id6">Windows module utilities</a><a class="headerlink" href="#windows-module-utilities" title="Permalink to this headline"></a></h2>
<p>Like Python modules, PowerShell modules also provide a number of module
utilities that provide helper functions within PowerShell. These module_utils
can be imported by adding the following line to a PowerShell module:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c">#Requires -Module Ansible.ModuleUtils.Legacy</span>
</pre></div>
</div>
<p>This will import the module_util at <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/powershell/Ansible.ModuleUtils.Legacy.psm1</span></code>
and enable calling all of its functions. As of Ansible 2.8, Windows module
utils can also be written in C# and stored at <code class="docutils literal notranslate"><span class="pre">lib/ansible/module_utils/csharp</span></code>.
These module_utils can be imported by adding the following line to a PowerShell
module:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c">#AnsibleRequires -CSharpUtil Ansible.Basic</span>
</pre></div>
</div>
<p>This will import the module_util at <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/csharp/Ansible.Basic.cs</span></code>
and automatically load the types in the executing process. C# module utils can
reference each other and be loaded together by adding the following line to the
using statements at the top of the util:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">Ansible.Become</span><span class="p">;</span>
</pre></div>
</div>
<p>There are special comments that can be set in a C# file for controlling the
compilation parameters. The following comments can be added to the script;</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">//AssemblyReference</span> <span class="pre">-Name</span> <span class="pre">&lt;assembly</span> <span class="pre">dll&gt;</span> <span class="pre">[-CLR</span> <span class="pre">[Core|Framework]]</span></code>: The assembly DLL to reference during compilation, the optional <code class="docutils literal notranslate"><span class="pre">-CLR</span></code> flag can also be used to state whether to reference when running under .NET Core, Framework, or both (if omitted)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">//NoWarn</span> <span class="pre">-Name</span> <span class="pre">&lt;error</span> <span class="pre">id&gt;</span> <span class="pre">[-CLR</span> <span class="pre">[Core|Framework]]</span></code>: A compiler warning ID to ignore when compiling the code, the optional <code class="docutils literal notranslate"><span class="pre">-CLR</span></code> works the same as above. A list of warnings can be found at <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-messages/index">Compiler errors</a></p></li>
</ul>
<p>As well as this, the following pre-processor symbols are defined;</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CORECLR</span></code>: This symbol is present when PowerShell is running through .NET Core</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WINDOWS</span></code>: This symbol is present when PowerShell is running on Windows</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNIX</span></code>: This symbol is present when PowerShell is running on Unix</p></li>
</ul>
<p>A combination of these flags help to make a module util interoperable on both
.NET Framework and .NET Core, here is an example of them in action:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="cp">#if CORECLR</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">using</span> <span class="nn">System.Web.Script.Serialization</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="c1">//AssemblyReference -Name Newtonsoft.Json.dll -CLR Core</span>
<span class="c1">//AssemblyReference -Name System.Web.Extensions.dll -CLR Framework</span>

<span class="c1">// Ignore error CS1702 for all .NET types</span>
<span class="c1">//NoWarn -Name CS1702</span>

<span class="c1">// Ignore error CS1956 only for .NET Framework</span>
<span class="c1">//NoWarn -Name CS1956 -CLR Framework</span>
</pre></div>
</div>
<p>The following is a list of module_utils that are packaged with Ansible and a general description of what
they do:</p>
<ul class="simple">
<li><p>ArgvParser: Utility used to convert a list of arguments to an escaped string compliant with the Windows argument parsing rules.</p></li>
<li><p>CamelConversion: Utility used to convert camelCase strings/lists/dicts to snake_case.</p></li>
<li><p>CommandUtil: Utility used to execute a Windows process and return the stdout/stderr and rc as separate objects.</p></li>
<li><p>FileUtil: Utility that expands on the <code class="docutils literal notranslate"><span class="pre">Get-ChildItem</span></code> and <code class="docutils literal notranslate"><span class="pre">Test-Path</span></code> to work with special files like <code class="docutils literal notranslate"><span class="pre">C:\pagefile.sys</span></code>.</p></li>
<li><p>Legacy: General definitions and helper utilities for Ansible module.</p></li>
<li><p>LinkUtil: Utility to create, remove, and get information about symbolic links, junction points and hard inks.</p></li>
<li><p>SID: Utilities used to convert a user or group to a Windows SID and vice versa.</p></li>
</ul>
<p>For more details on any specific module utility and their requirements, please see the <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/module_utils/powershell">Ansible
module utilities source code</a>.</p>
<p>PowerShell module utilities can be stored outside of the standard Ansible
distribution for use with custom modules. Custom module_utils are placed in a
folder called <code class="docutils literal notranslate"><span class="pre">module_utils</span></code> located in the root folder of the playbook or role
directory.</p>
<p>C# module utilities can also be stored outside of the standard Ansible distribution for use with custom modules. Like
PowerShell utils, these are stored in a folder called <code class="docutils literal notranslate"><span class="pre">module_utils</span></code> and the filename must end in the extension
<code class="docutils literal notranslate"><span class="pre">.cs</span></code>, start with <code class="docutils literal notranslate"><span class="pre">Ansible.</span></code>  and be named after the namespace defined in the util.</p>
<p>The below example is a role structure that contains two PowerShell custom module_utils called
<code class="docutils literal notranslate"><span class="pre">Ansible.ModuleUtils.ModuleUtil1</span></code>, <code class="docutils literal notranslate"><span class="pre">Ansible.ModuleUtils.ModuleUtil2</span></code>, and a C# util containing the namespace
<code class="docutils literal notranslate"><span class="pre">Ansible.CustomUtil</span></code>:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">meta/</span>
  <span class="l l-Scalar l-Scalar-Plain">main.yml</span>
<span class="l l-Scalar l-Scalar-Plain">defaults/</span>
  <span class="l l-Scalar l-Scalar-Plain">main.yml</span>
<span class="l l-Scalar l-Scalar-Plain">module_utils/</span>
  <span class="l l-Scalar l-Scalar-Plain">Ansible.ModuleUtils.ModuleUtil1.psm1</span>
  <span class="l l-Scalar l-Scalar-Plain">Ansible.ModuleUtils.ModuleUtil2.psm1</span>
  <span class="l l-Scalar l-Scalar-Plain">Ansible.CustomUtil.cs</span>
<span class="l l-Scalar l-Scalar-Plain">tasks/</span>
  <span class="l l-Scalar l-Scalar-Plain">main.yml</span>
</pre></div>
</div>
<p>Each PowerShell module_util must contain at least one function that has been exported with <code class="docutils literal notranslate"><span class="pre">Export-ModuleMember</span></code>
at the end of the file. For example</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">Export-ModuleMember</span> <span class="n">-Function</span> <span class="nb">Invoke-CustomUtil</span><span class="p">,</span> <span class="nb">Get-CustomInfo</span>
</pre></div>
</div>
<section id="exposing-shared-module-options">
<h3><a class="toc-backref" href="#id7">Exposing shared module options</a><a class="headerlink" href="#exposing-shared-module-options" title="Permalink to this headline"></a></h3>
<p>PowerShell module utils can easily expose common module options that a module can use when building its argument spec.
This allows common features to be stored and maintained in one location and have those features used by multiple
modules with minimal effort. Any new features or bugfixes added to one of these utils are then automatically used by
the various modules that call that util.</p>
<p>An example of this would be to have a module util that handles authentication and communication against an API This
util can be used by multiple modules to expose a common set of module options like the API endpoint, username,
password, timeout, cert validation, and so on without having to add those options to each module spec.</p>
<p>The standard convention for a module util that has a shared argument spec would have</p>
<ul class="simple">
<li><dl class="simple">
<dt>A <code class="docutils literal notranslate"><span class="pre">Get-&lt;namespace.name.util</span> <span class="pre">name&gt;Spec</span></code> function that outputs the common spec for a module</dt><dd><ul>
<li><p>It is highly recommended to make this function name be unique to the module to avoid any conflicts with other utils that can be loaded</p></li>
<li><p>The format of the output spec is a Hashtable in the same format as the <code class="docutils literal notranslate"><span class="pre">$spec</span></code> used for normal modules</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>A function that takes in an <code class="docutils literal notranslate"><span class="pre">AnsibleModule</span></code> object called under the <code class="docutils literal notranslate"><span class="pre">-Module</span></code> parameter which it can use to get the shared options</p></li>
</ul>
<p>Because these options can be shared across various module it is highly recommended to keep the module option names and
aliases in the shared spec as specific as they can be. For example do not have a util option called <code class="docutils literal notranslate"><span class="pre">password</span></code>,
rather you should prefix it with a unique name like <code class="docutils literal notranslate"><span class="pre">acme_password</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Failure to have a unique option name or alias can prevent the util being used by module that also use those names or
aliases for its own options.</p>
</div>
<p>The following is an example module util called <code class="docutils literal notranslate"><span class="pre">ServiceAuth.psm1</span></code> in a collection that implements a common way for
modules to authentication with a service.</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">Invoke-MyServiceResource</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
    <span class="k">param</span> <span class="p">(</span>
        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">ValidateScript</span><span class="p">({</span> <span class="nv">$_</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">FullName</span> <span class="o">-eq</span> <span class="s1">&#39;Ansible.Basic.AnsibleModule&#39;</span> <span class="p">})]</span>
        <span class="nv">$Module</span><span class="p">,</span>

        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span>
        <span class="no">[String]</span>
        <span class="nv">$ResourceId</span><span class="p">,</span>

        <span class="no">[String]</span>
        <span class="nv">$State</span> <span class="p">=</span> <span class="s1">&#39;present&#39;</span>
    <span class="p">)</span>

    <span class="c"># Process the common module options known to the util</span>
    <span class="nv">$params</span> <span class="p">=</span> <span class="p">@{</span>
        <span class="n">ServerUri</span> <span class="p">=</span> <span class="nv">$Module</span><span class="p">.</span><span class="n">Params</span><span class="p">.</span><span class="n">my_service_url</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$Module</span><span class="p">.</span><span class="n">Params</span><span class="p">.</span><span class="n">my_service_username</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$params</span><span class="p">.</span><span class="n">Credential</span> <span class="p">=</span> <span class="nb">Get-MyServiceCredential</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$State</span> <span class="o">-eq</span> <span class="s1">&#39;absent&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Remove-MyService</span> <span class="nv">@params</span> <span class="n">-ResourceId</span> <span class="nv">$ResourceId</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">New-MyService</span> <span class="nv">@params</span> <span class="n">-ResourceId</span> <span class="nv">$ResourceId</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">Get-MyNamespaceMyCollectionServiceAuthSpec</span> <span class="p">{</span>
    <span class="c"># Output the util spec</span>
    <span class="p">@{</span>
        <span class="n">options</span> <span class="p">=</span> <span class="p">@{</span>
            <span class="n">my_service_url</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="s1">&#39;str&#39;</span><span class="p">;</span> <span class="n">required</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
            <span class="n">my_service_username</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="s1">&#39;str&#39;</span> <span class="p">}</span>
            <span class="n">my_service_password</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="s1">&#39;str&#39;</span><span class="p">;</span> <span class="n">no_log</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">required_together</span> <span class="p">=</span> <span class="p">@(</span>
            <span class="p">,@(</span><span class="s1">&#39;my_service_username&#39;</span><span class="p">,</span> <span class="s1">&#39;my_service_password&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$exportMembers</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="k">Function</span> <span class="p">=</span> <span class="s1">&#39;Get-MyNamespaceMyCollectionServiceAuthSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;Invoke-MyServiceResource&#39;</span>
<span class="p">}</span>
<span class="nb">Export-ModuleMember</span> <span class="nv">@exportMembers</span>
</pre></div>
</div>
<p>For a module to take advantage of this common argument spec it can be set out like</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c">#!powershell</span>

<span class="c"># Include the module util ServiceAuth.psm1 from the my_namespace.my_collection collection</span>
<span class="c">#AnsibleRequires -PowerShell ansible_collections.my_namespace.my_collection.plugins.module_utils.ServiceAuth</span>

<span class="c"># Create the module spec like normal</span>
<span class="nv">$spec</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">options</span> <span class="p">=</span> <span class="p">@{</span>
        <span class="n">resource_id</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="s1">&#39;str&#39;</span><span class="p">;</span> <span class="n">required</span> <span class="p">=</span> <span class="nv">$true</span> <span class="p">}</span>
        <span class="n">state</span> <span class="p">=</span> <span class="p">@{</span> <span class="nb">type </span><span class="p">=</span> <span class="s1">&#39;str&#39;</span><span class="p">;</span> <span class="n">choices</span> <span class="p">=</span> <span class="s1">&#39;absent&#39;</span><span class="p">,</span> <span class="s1">&#39;present&#39;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># Create the module from the module spec but also include the util spec to merge into our own.</span>
<span class="nv">$module</span> <span class="p">=</span> <span class="no">[Ansible.Basic.AnsibleModule]</span><span class="p">::</span><span class="n">Create</span><span class="p">(</span><span class="nv">$args</span><span class="p">,</span> <span class="nv">$spec</span><span class="p">,</span> <span class="p">@(</span><span class="nb">Get-MyNamespaceMyCollectionServiceAuthSpec</span><span class="p">))</span>

<span class="c"># Call the ServiceAuth module util and pass in the module object so it can access the module options.</span>
<span class="nb">Invoke-MyServiceResource</span> <span class="n">-Module</span> <span class="nv">$module</span> <span class="n">-ResourceId</span> <span class="nv">$module</span><span class="p">.</span><span class="n">Params</span><span class="p">.</span><span class="n">resource_id</span> <span class="n">-State</span> <span class="nv">$module</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">state</span>

<span class="nv">$module</span><span class="p">.</span><span class="n">ExitJson</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Options defined in the module spec will always have precedence over a util spec. Any list values under the same key
in a util spec will be appended to the module spec for that same key. Dictionary values will add any keys that are
missing from the module spec and merge any values that are lists or dictionaries. This is similar to how the doc
fragment plugins work when extending module documentation.</p>
</div>
<p>To document these shared util options for a module, create a doc fragment plugin that documents the options implemented
by the module util and extend the module docs for every module that implements the util to include that fragment in
its docs.</p>
</section>
</section>
<section id="windows-playbook-module-testing">
<h2><a class="toc-backref" href="#id8">Windows playbook module testing</a><a class="headerlink" href="#windows-playbook-module-testing" title="Permalink to this headline"></a></h2>
<p>You can test a module with an Ansible playbook. For example:</p>
<ul>
<li><p>Create a playbook in any directory <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">testmodule.yml</span></code>.</p></li>
<li><p>Create an inventory file in the same directory <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">hosts</span></code>.</p></li>
<li><p>Populate the inventory file with the variables required to connect to a Windows host(s).</p></li>
<li><p>Add the following to the new playbook file:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test out windows module</span>
  <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">windows</span>
  <span class="nt">tasks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test out module</span>
    <span class="nt">win_module</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test name</span>
</pre></div>
</div>
</li>
<li><p>Run the playbook <code class="docutils literal notranslate"><span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">hosts</span> <span class="pre">testmodule.yml</span></code></p></li>
</ul>
<p>This can be useful for seeing how Ansible runs with
the new module end to end. Other possible ways to test the module are
shown below.</p>
</section>
<section id="windows-debugging">
<h2><a class="toc-backref" href="#id9">Windows debugging</a><a class="headerlink" href="#windows-debugging" title="Permalink to this headline"></a></h2>
<p>Debugging a module currently can only be done on a Windows host. This can be
useful when developing a new module or implementing bug fixes. These
are some steps that need to be followed to set this up:</p>
<ul class="simple">
<li><p>Copy the module script to the Windows server</p></li>
<li><p>Copy the folders <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/powershell</span></code> and <code class="docutils literal notranslate"><span class="pre">./lib/ansible/module_utils/csharp</span></code> to the same directory as the script above</p></li>
<li><p>Add an extra <code class="docutils literal notranslate"><span class="pre">#</span></code> to the start of any <code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span></code> lines in the module code, this is only required for any lines starting with <code class="docutils literal notranslate"><span class="pre">#Requires</span> <span class="pre">-Module</span></code></p></li>
<li><p>Add the following to the start of the module script that was copied to the server:</p></li>
</ul>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Set $ErrorActionPreference to what&#39;s set during Ansible execution</span>
<span class="nv">$ErrorActionPreference</span> <span class="p">=</span> <span class="s2">&quot;Stop&quot;</span>

<span class="c"># Set the first argument as the path to a JSON file that contains the module args</span>
<span class="nv">$args</span> <span class="p">=</span> <span class="p">@(</span><span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$pwd</span><span class="p">.</span><span class="n">Path</span><span class="p">)</span><span class="s2">\args.json&quot;</span><span class="p">)</span>

<span class="c"># Or instead of an args file, set $complex_args to the pre-processed module args</span>
<span class="nv">$complex_args</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">_ansible_check_mode</span> <span class="p">=</span> <span class="nv">$false</span>
    <span class="n">_ansible_diff</span> <span class="p">=</span> <span class="nv">$false</span>
    <span class="n">path</span> <span class="p">=</span> <span class="s2">&quot;C:\temp&quot;</span>
    <span class="n">state</span> <span class="p">=</span> <span class="s2">&quot;present&quot;</span>
<span class="p">}</span>

<span class="c"># Import any C# utils referenced with &#39;#AnsibleRequires -CSharpUtil&#39; or &#39;using Ansible.;</span>
<span class="c"># The $_csharp_utils entries should be the context of the C# util files and not the path</span>
<span class="nb">Import-Module</span> <span class="n">-Name</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$pwd</span><span class="p">.</span><span class="n">Path</span><span class="p">)</span><span class="s2">\powershell\Ansible.ModuleUtils.AddType.psm1&quot;</span>
<span class="nv">$_csharp_utils</span> <span class="p">=</span> <span class="p">@(</span>
    <span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$pwd</span><span class="p">.</span><span class="n">Path</span><span class="p">)</span><span class="s2">\csharp\Ansible.Basic.cs&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">Add-CSharpType</span> <span class="n">-References</span> <span class="nv">$_csharp_utils</span> <span class="n">-IncludeDebugInfo</span>

<span class="c"># Import any PowerShell modules referenced with &#39;#Requires -Module`</span>
<span class="nb">Import-Module</span> <span class="n">-Name</span> <span class="s2">&quot;</span><span class="p">$(</span><span class="nv">$pwd</span><span class="p">.</span><span class="n">Path</span><span class="p">)</span><span class="s2">\powershell\Ansible.ModuleUtils.Legacy.psm1&quot;</span>

<span class="c"># End of the setup code and start of the module code</span>
<span class="c">#!powershell</span>
</pre></div>
</div>
<p>You can add more args to <code class="docutils literal notranslate"><span class="pre">$complex_args</span></code> as required by the module or define the module options through a JSON file
with the structure:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;ANSIBLE_MODULE_ARGS&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;_ansible_check_mode&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;_ansible_diff&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;C:\\temp&quot;</span><span class="p">,</span>
        <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;present&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are multiple IDEs that can be used to debug a Powershell script, two of
the most popular ones are</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise">Powershell ISE</a></p></li>
<li><p><a class="reference external" href="https://blogs.technet.microsoft.com/heyscriptingguy/2017/02/06/debugging-powershell-script-in-visual-studio-code-part-1/">Visual Studio Code</a></p></li>
</ul>
<p>To be able to view the arguments as passed by Ansible to the module follow
these steps.</p>
<ul class="simple">
<li><p>Prefix the Ansible command with <span class="target" id="index-0"></span><a class="reference internal" href="../reference_appendices/config.html#envvar-ANSIBLE_KEEP_REMOTE_FILES"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">ANSIBLE_KEEP_REMOTE_FILES=1</span></code></a> to specify that Ansible should keep the exec files on the server.</p></li>
<li><p>Log onto the Windows server using the same user account that Ansible used to execute the module.</p></li>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">%TEMP%\..</span></code>. It should contain a folder starting with <code class="docutils literal notranslate"><span class="pre">ansible-tmp-</span></code>.</p></li>
<li><p>Inside this folder, open the PowerShell script for the module.</p></li>
<li><p>In this script is a raw JSON script under <code class="docutils literal notranslate"><span class="pre">$json_raw</span></code> which contains the module arguments under <code class="docutils literal notranslate"><span class="pre">module_args</span></code>. These args can be assigned manually to the <code class="docutils literal notranslate"><span class="pre">$complex_args</span></code> variable that is defined on your debug script or put in the <code class="docutils literal notranslate"><span class="pre">args.json</span></code> file.</p></li>
</ul>
</section>
<section id="windows-unit-testing">
<h2><a class="toc-backref" href="#id10">Windows unit testing</a><a class="headerlink" href="#windows-unit-testing" title="Permalink to this headline"></a></h2>
<p>Currently there is no mechanism to run unit tests for Powershell modules under Ansible CI.</p>
</section>
<section id="windows-integration-testing">
<h2><a class="toc-backref" href="#id11">Windows integration testing</a><a class="headerlink" href="#windows-integration-testing" title="Permalink to this headline"></a></h2>
<p>Integration tests for Ansible modules are typically written as Ansible roles. These test
roles are located in <code class="docutils literal notranslate"><span class="pre">./test/integration/targets</span></code>. You must first set up your testing
environment, and configure a test inventory for Ansible to connect to.</p>
<p>In this example we will set up a test inventory to connect to two hosts and run the integration
tests for win_stat:</p>
<ul class="simple">
<li><p>Run the command <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">./hacking/env-setup</span></code> to prepare environment.</p></li>
<li><p>Create a copy of <code class="docutils literal notranslate"><span class="pre">./test/integration/inventory.winrm.template</span></code> and name it <code class="docutils literal notranslate"><span class="pre">inventory.winrm</span></code>.</p></li>
<li><p>Fill in entries under <code class="docutils literal notranslate"><span class="pre">[windows]</span></code> and set the required variables that are needed to connect to the host.</p></li>
<li><p><a class="reference internal" href="../user_guide/windows_winrm.html#windows-winrm"><span class="std std-ref">Install the required Python modules</span></a> to support WinRM and a configured authentication method.</p></li>
<li><p>To execute the integration tests, run <code class="docutils literal notranslate"><span class="pre">ansible-test</span> <span class="pre">windows-integration</span> <span class="pre">win_stat</span></code>; you can replace <code class="docutils literal notranslate"><span class="pre">win_stat</span></code> with the role you want to test.</p></li>
</ul>
<p>This will execute all the tests currently defined for that role. You can set
the verbosity level using the <code class="docutils literal notranslate"><span class="pre">-v</span></code> argument just as you would with
ansible-playbook.</p>
<p>When developing tests for a new module, it is recommended to test a scenario once in
check mode and twice not in check mode. This ensures that check mode
does not make any changes but reports a change, as well as that the second run is
idempotent and does not report changes. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file (check mode)</span>
  <span class="nt">win_file</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_check</span>
  <span class="nt">check_mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">get result of remove a file (check mode)</span>
  <span class="nt">win_command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">powershell.exe &quot;if (Test-Path -Path &#39;C:\temp&#39;) { &#39;true&#39; } else { &#39;false&#39; }&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual_check</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file (check mode)</span>
  <span class="nt">assert</span><span class="p">:</span>
    <span class="nt">that</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_check is changed</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual_check.stdout == &#39;true\r\n&#39;</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file</span>
  <span class="nt">win_file</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">get result of remove a file</span>
  <span class="nt">win_command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">powershell.exe &quot;if (Test-Path -Path &#39;C:\temp&#39;) { &#39;true&#39; } else { &#39;false&#39; }&quot;</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file</span>
  <span class="nt">assert</span><span class="p">:</span>
    <span class="nt">that</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file is changed</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual.stdout == &#39;false\r\n&#39;</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file (idempotent)</span>
  <span class="nt">win_file</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_again</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file (idempotent)</span>
  <span class="nt">assert</span><span class="p">:</span>
    <span class="nt">that</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">not remove_file_again is changed</span>
</pre></div>
</div>
</section>
<section id="windows-communication-and-development-support">
<h2><a class="toc-backref" href="#id12">Windows communication and development support</a><a class="headerlink" href="#windows-communication-and-development-support" title="Permalink to this headline"></a></h2>
<p>Join the <code class="docutils literal notranslate"><span class="pre">#ansible-devel</span></code> or <code class="docutils literal notranslate"><span class="pre">#ansible-windows</span></code> chat channels (using Matrix at ansible.im or using IRC at <a class="reference external" href="https://libera.chat/">irc.libera.chat</a>) for discussions about Ansible development for Windows.</p>
<p>For questions and discussions pertaining to using the Ansible product,
use the <code class="docutils literal notranslate"><span class="pre">#ansible</span></code> channel.</p>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="developing_modules_documenting.html" class="btn btn-neutral float-left" title="Module format and documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="developing_modules_general_aci.html" class="btn btn-neutral float-right" title="Developing Cisco ACI modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible project contributors.
      <span class="lastupdated">Last updated on Jun 27, 2022.
      </span></p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->
<!-- begin analytics -->
<script>
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
      (function(d,s,i,r) {
      if (d.getElementById(i)){return;}
      var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
      n.id=i;n.src = 'https://js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
      e.parentNode.insertBefore(n, e);
      })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script>
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
  _satellite.pageBottom();
}
</script>

</body>
</html>